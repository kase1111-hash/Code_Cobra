# Code Cobra Architecture

## System Overview

Code Cobra is a multi-agent AI coding system that processes specifications through a three-model pipeline to produce quality-checked, security-hardened code.

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           USER INPUT                                     │
│                    (Spec + Guide File)                                   │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        CLI INTERFACE                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                │
│  │  --spec  │  │ --guide  │  │--verbose │  │--dry-run │                │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘                │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      WORKFLOW ENGINE                                     │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐        │
│  │  Guide Loader  │───▶│  Step Parser   │───▶│ State Manager  │        │
│  │   (*.txt)      │    │  (regex)       │    │ (cumulative)   │        │
│  └────────────────┘    └────────────────┘    └────────────────┘        │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      MODEL PIPELINE                                      │
│                                                                          │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐        │
│  │   MODEL A      │    │   MODEL B      │    │   MODEL C      │        │
│  │   Creative     │───▶│   Analyst      │───▶│   Adversary    │        │
│  │   (temp 0.8)   │    │   (temp 0.3)   │    │   (temp 0.7)   │        │
│  │                │    │                │    │                │        │
│  │  "Draft code"  │    │ "Fix errors"   │    │ "Find vulns"   │        │
│  └────────────────┘    └────────────────┘    └────────────────┘        │
│         │                     │                     │                   │
│         │              ┌──────┴──────┐       ┌──────┴──────┐           │
│         │              │  Iteration  │       │  Iteration  │           │
│         │              │  (max 3x)   │       │  (max 3x)   │           │
│         │              └─────────────┘       └─────────────┘           │
│         │                     │                     │                   │
│         └─────────────────────┴─────────────────────┘                   │
│                               │                                          │
│                        ┌──────┴──────┐                                  │
│                        │   Hooks     │                                  │
│                        │ (optional)  │                                  │
│                        └─────────────┘                                  │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        ACCUMULATOR                                       │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │  --- Step 1 Output ---                                       │        │
│  │  [Secured output from step 1]                                │        │
│  │                                                              │        │
│  │  --- Step 2 Output ---                                       │        │
│  │  [Secured output from step 2]                                │        │
│  │  ...                                                         │        │
│  └─────────────────────────────────────────────────────────────┘        │
└────────────────────────────┬────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        OUTPUT                                            │
│                   (final_output.txt)                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Diagram

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│   Spec   │     │  Guide   │     │  Config  │
│  (text)  │     │  (.txt)  │     │  (.json) │
└────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │
     └────────────────┼────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │ WorkflowEngine│
              └───────┬───────┘
                      │
         ┌────────────┼────────────┐
         │            │            │
         ▼            ▼            ▼
    ┌─────────┐  ┌─────────┐  ┌─────────┐
    │ Step 1  │  │ Step 2  │  │ Step N  │
    └────┬────┘  └────┬────┘  └────┬────┘
         │            │            │
         ▼            ▼            ▼
    ┌─────────────────────────────────┐
    │        For Each Step:           │
    │                                 │
    │  ┌─────────┐                    │
    │  │ Model A │ ─── Draft ───┐     │
    │  └─────────┘               │     │
    │                            ▼     │
    │  ┌─────────┐          ┌───────┐ │
    │  │ Model B │◄─────────│ Loop  │ │
    │  └────┬────┘          │ ≤3x   │ │
    │       │               └───────┘ │
    │       ▼                         │
    │  ┌─────────┐          ┌───────┐ │
    │  │ Model C │◄─────────│ Loop  │ │
    │  └────┬────┘          │ ≤3x   │ │
    │       │               └───────┘ │
    │       ▼                         │
    │  ┌─────────┐                    │
    │  │Checkpoint│ (optional)        │
    │  └─────────┘                    │
    └─────────────────────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │   Output.txt  │
              └───────────────┘
```

## Component Interaction

```
┌─────────────────────────────────────────────────────────────────┐
│                    autonomous_ensemble.py                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐         ┌──────────────┐                      │
│  │    Config    │◄───────▶│ OllamaClient │                      │
│  │  (settings)  │         │   (HTTP)     │                      │
│  └──────────────┘         └──────┬───────┘                      │
│         │                        │                               │
│         ▼                        ▼                               │
│  ┌──────────────┐         ┌──────────────┐                      │
│  │ GuideLoader  │         │ModelPipeline │                      │
│  │  (parsing)   │         │  (3 models)  │                      │
│  └──────┬───────┘         └──────┬───────┘                      │
│         │                        │                               │
│         ▼                        ▼                               │
│  ┌──────────────┐         ┌──────────────┐                      │
│  │ StateManager │◄───────▶│  StepContext │                      │
│  │ (cumulative) │         │  (per-step)  │                      │
│  └──────┬───────┘         └──────────────┘                      │
│         │                                                        │
│         ▼                                                        │
│  ┌──────────────┐         ┌──────────────┐                      │
│  │  Checkpoint  │         │  GuideChain  │                      │
│  │  (resume)    │         │  (multi-file)│                      │
│  └──────────────┘         └──────────────┘                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   Ollama API     │
                    │ localhost:11434  │
                    └──────────────────┘
```

## Model Temperature Strategy

```
Temperature Scale: 0.0 ──────────────────────────────────────── 1.0
                   │                                              │
                   │  Deterministic              Creative         │
                   │  Focused                    Exploratory      │
                   │                                              │
                   │         0.3         0.7         0.8          │
                   │          │           │           │           │
                   │          ▼           ▼           ▼           │
                   │     ┌─────────┐ ┌─────────┐ ┌─────────┐     │
                   │     │Model B  │ │Model C  │ │Model A  │     │
                   │     │Analyst  │ │Adversary│ │Creative │     │
                   │     └─────────┘ └─────────┘ └─────────┘     │
                   │          │           │           │           │
                   │     Precise     Balanced     Imaginative    │
                   │     Fixes       Probing      Drafting       │
```

## Extension Points

```
┌─────────────────────────────────────────────────────────────────┐
│                     EXTENSION HOOKS                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Model A ──▶ [post_draft hook] ──▶ Model B                      │
│                                                                  │
│  Model B ──▶ [post_correction hook] ──▶ Model C                 │
│                                                                  │
│  Model C ──▶ [post_security hook] ──▶ Accumulator               │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                     GUIDE CHAINING                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Guide 1 ──▶ Output 1 ──┐                                       │
│                         ├──▶ Context ──▶ Guide 2 ──▶ Output 2   │
│  Guide 2 ◀──────────────┘                                       │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                     CHECKPOINT/RESUME                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step N ──▶ Save State ──▶ checkpoint.json                      │
│                                    │                             │
│  Resume ◀──────────────────────────┘                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Security Model

```
┌─────────────────────────────────────────────────────────────────┐
│                     SECURITY BOUNDARIES                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    LOCAL NETWORK ONLY                    │    │
│  │  ┌─────────────┐           ┌─────────────┐              │    │
│  │  │ Code Cobra  │◄─────────▶│   Ollama    │              │    │
│  │  │ (Container) │  HTTP     │ (localhost) │              │    │
│  │  └─────────────┘           └─────────────┘              │    │
│  │         │                                                │    │
│  │         ▼                                                │    │
│  │  ┌─────────────┐                                        │    │
│  │  │   Output    │ (review before production use)         │    │
│  │  └─────────────┘                                        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  - No external API calls                                         │
│  - Spec/output files are sensitive                              │
│  - Model C prompts not exposed to untrusted input               │
│  - Non-root container user                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```
